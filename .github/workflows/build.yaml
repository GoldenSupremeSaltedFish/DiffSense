name: DiffSense CI

on:
  push:
    branches: ["main", "release/**"]
  pull_request:
    branches: ["main", "release/**"]

jobs:
  build:
    name: Build DiffSense
    runs-on: ubuntu-latest
    
    # æ·»åŠ æƒé™é…ç½®
    permissions:
      contents: write
      packages: write
      
    env:
      PLUGIN_DIR: ${{ github.workspace }}/plugin
      UI_DIR: ${{ github.workspace }}/ui
      FRONTEND_DIST: ${{ github.workspace }}/ui/diffsense-frontend/dist
      FRONTEND_TARGET: ${{ github.workspace }}/plugin/ui/diffsense-frontend
      VITE_OUT_DIR: dist
      
    steps:
      - uses: actions/checkout@v3
      
      # è®¾ç½®JavaçŽ¯å¢ƒ
      - name: Set up JDK
        uses: actions/setup-java@v3
        with:
          java-version: "17"
          distribution: "temurin"
          cache: maven
          
      # æž„å»ºJavaåˆ†æžå™¨
      - name: Build Java Analyzer
        run: mvn clean package -DskipTests
      
      # è®¾ç½®NodeçŽ¯å¢ƒ
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: |
            ui/diffsense-frontend/package-lock.json
            plugin/package-lock.json

      # å®‰è£…å‰ç«¯ä¾èµ–å¹¶æž„å»º
      - name: Build Frontend
        working-directory: ui/diffsense-frontend
        run: |
          echo "Building frontend in $(pwd)"
          echo "Frontend dist directory: $FRONTEND_DIST"
          echo "Frontend target directory: $FRONTEND_TARGET"
          echo "Vite output directory: $VITE_OUT_DIR"
          
          # æ£€æŸ¥å’Œåˆ›å»ºç›®å½•
          mkdir -p dist
          chmod -R 755 .
          
          echo "Directory contents and permissions before build:"
          ls -la
          
          # å®‰è£…ä¾èµ–å’Œæž„å»º
          npm install
          npm run build
          
          echo "Directory contents and permissions after build:"
          ls -la
          ls -la dist/ || echo "dist/ directory not found"
          
          # å¦‚æžœdistç›®å½•å­˜åœ¨ï¼Œæ˜¾ç¤ºå…¶å†…å®¹å’Œæƒé™
          if [ -d "dist" ]; then
            echo "dist directory exists, contents and permissions:"
            ls -la dist/
            
            # ç¡®ä¿distç›®å½•æœ‰æ­£ç¡®çš„æƒé™
            chmod -R 755 dist/
          else
            echo "dist directory was not created!"
            exit 1
          fi
          
      # å®‰è£…æ’ä»¶ä¾èµ–å¹¶æž„å»º
      - name: Build VSCode Extension
        working-directory: vscode-extension/plugin
        run: |
          echo "Building plugin in $(pwd)"
          echo "Directory contents and permissions before build:"
          ls -la
          
          # åˆ›å»ºå¿…è¦çš„ç›®å½•
          mkdir -p ui/diffsense-frontend
          chmod -R 755 .
          
          npm install
          npm run build
          
          echo "Directory contents and permissions after build:"
          ls -la
          echo "UI directory contents and permissions:"
          ls -la ui/diffsense-frontend/ || echo "UI directory not found"
          
      # ä½¿ç”¨ä¸Žæœ¬åœ°ä¸€è‡´çš„ prepare-release æµç¨‹
      - name: Prepare Release Folder
        working-directory: plugin
        run: npm run prepare-release

      # åœ¨ release ç›®å½•æ‰“åŒ… VSIX
      - name: Package VSIX from Release
        working-directory: plugin/release
        run: |
          echo "Packaging VSIX in $(pwd)"
          npx vsce package --no-yarn

      # èŽ·å–ç‰ˆæœ¬å·
      - name: Get Version
        id: get_version
        shell: bash
        run: |
          VERSION=$(node -p "require('${PLUGIN_DIR}/package.json').version")
          echo "VERSION=${VERSION}" >> $GITHUB_ENV
          echo "Building version: ${VERSION}"
          
            # æž„å»ºå®Œæˆï¼Œå‡†å¤‡åŒæ­¥äº§ç‰©åˆ°å­ä»“åº“
      - name: Build Complete
        if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/heads/release/'))
        run: |
          echo "âœ… æž„å»ºå®Œæˆï¼Œç‰ˆæœ¬: ${{ env.VERSION }}"
          echo "ðŸ“¦ äº§ç‰©ä½ç½®: ${{ env.PLUGIN_DIR }}/release/"
          echo "ðŸ”„ å‡†å¤‡åŒæ­¥åˆ°å­ä»“åº“..."
          
      # ä¸Šä¼ æž„å»ºäº§ç‰©ï¼ˆç”¨äºŽè°ƒè¯•å’ŒéªŒè¯ï¼‰
      - name: Upload Build Artifacts
        uses: actions/upload-artifact@v4.6.2
        with:
          name: DiffSense-${{ env.VERSION }}-Full
          path: |
            ${{ env.PLUGIN_DIR }}/release/analyzers/
            ${{ env.PLUGIN_DIR }}/release/ui/
            ${{ env.PLUGIN_DIR }}/release/*.vsix
          retention-days: 14

      # åŒæ­¥äº§ç‰©åˆ°å­ä»“åº“
      - name: Sync Artifacts to Sub Repository
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        working-directory: plugin
        env:
          ARTIFACTS_TOKEN: ${{ secrets.ARTIFACTS_TOKEN }}
        run: |
          echo "ðŸ”„ å¼€å§‹åŒæ­¥äº§ç‰©åˆ°å­ä»“åº“..."
          
          # å‡†å¤‡äº§ç‰©ç›®å½•
          mkdir -p artifacts-staging
          
          echo "ðŸ“¦ å‡†å¤‡æž„å»ºäº§ç‰©..."
          
          # å¤åˆ¶ç¼–è¯‘åŽçš„TypeScriptä»£ç 
          if [ -d "dist" ]; then
            cp -r dist artifacts-staging/
            echo "âœ… TypeScript ç¼–è¯‘ä»£ç å·²å¤åˆ¶"
          fi
          
          # å¤åˆ¶åˆ†æžå™¨äº§ç‰©
          if [ -d "analyzers" ]; then
            cp -r analyzers artifacts-staging/
            echo "âœ… åˆ†æžå™¨äº§ç‰©å·²å¤åˆ¶"
          fi
          
          # å¤åˆ¶UIäº§ç‰©
          if [ -d "ui" ]; then
            cp -r ui artifacts-staging/
            echo "âœ… UIäº§ç‰©å·²å¤åˆ¶"
          fi
          
          # å¤åˆ¶VSIXæ–‡ä»¶
          if [ -d "release" ]; then
            cp release/*.vsix artifacts-staging/ 2>/dev/null || echo "âš ï¸ æœªæ‰¾åˆ°VSIXæ–‡ä»¶"
            echo "âœ… VSIXæ–‡ä»¶å·²å¤åˆ¶"
          fi
          
          # å¤åˆ¶å¿…è¦çš„é…ç½®æ–‡ä»¶
          cp package.json artifacts-staging/
          cp tsconfig.json artifacts-staging/
          cp icon.png artifacts-staging/
          cp LICENSE.txt artifacts-staging/
          cp README.md artifacts-staging/
          cp .vscodeignore artifacts-staging/
          
          echo "âœ… é…ç½®æ–‡ä»¶å·²å¤åˆ¶"
          
          # åˆ›å»ºè¿è¡Œæ—¶é…ç½®æ–‡ä»¶
          cat > artifacts-staging/runtime-config.json << EOF
          {
            "version": "$(node -p "require('./package.json').version")",
            "buildTime": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "commit": "${{ github.sha }}",
            "branch": "${{ github.ref_name }}",
            "isProduction": true,
            "debugMode": false,
            "artifactsOnly": true,
            "buildInfo": {
              "javaAnalyzer": "$(ls analyzers/*.jar 2>/dev/null | wc -l) JAR files",
              "nodeAnalyzer": "$(ls analyzers/node-analyzer/*.js 2>/dev/null | wc -l) JS files",
              "golangAnalyzer": "$(ls analyzers/golang-analyzer/*.js 2>/dev/null | wc -l) JS files",
              "frontend": "$(ls ui/index.html 2>/dev/null | wc -l) files",
              "vsix": "$(ls release/*.vsix 2>/dev/null | wc -l) files"
            }
          }
          EOF
          
          echo "âœ… è¿è¡Œæ—¶é…ç½®å·²åˆ›å»º"
          
          # æ˜¾ç¤ºäº§ç‰©ç»Ÿè®¡
          echo "ðŸ“Š äº§ç‰©ç»Ÿè®¡:"
          find artifacts-staging -type f -name "*.jar" | wc -l | xargs echo "JARæ–‡ä»¶:"
          find artifacts-staging -type f -name "*.js" | wc -l | xargs echo "JSæ–‡ä»¶:"
          find artifacts-staging -type f -name "*.html" | wc -l | xargs echo "HTMLæ–‡ä»¶:"
          find artifacts-staging -type f -name "*.vsix" | wc -l | xargs echo "VSIXæ–‡ä»¶:"
          
          # æŽ¨é€åˆ° artifacts ä»“åº“
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          if [ -z "$ARTIFACTS_TOKEN" ]; then
            echo "âŒ é”™è¯¯: ARTIFACTS_TOKEN æœªè®¾ç½®"
            exit 1
          fi
          
          echo "ðŸ”„ å…‹éš†äº§ç‰©ä»“åº“..."
          git clone https://x-access-token:${ARTIFACTS_TOKEN}@github.com/GoldenSupremeSaltedFish/Diffsense-artifacts.git artifacts-repo
          
          # æ¸…ç©ºå¹¶å¤åˆ¶æ–°çš„æž„å»ºäº§ç‰©
          cd artifacts-repo
          echo "ðŸ—‘ï¸ æ¸…ç†çŽ°æœ‰äº§ç‰©..."
          rm -rf *
          
          echo "ðŸ“¦ å¤åˆ¶æ–°äº§ç‰©..."
          cp -r ../artifacts-staging/* .
          
          # åˆ›å»ºäº§ç‰©ä»“åº“çš„ README
          cat > README.md << 'EOF'
          # DiffSense Plugin Artifacts
          
          è¿™ä¸ªä»“åº“åŒ…å« **DiffSense VSCode æ’ä»¶çš„æž„å»ºäº§ç‰©**ï¼Œç”¨äºŽåˆ†å‘å’Œè°ƒè¯•ã€‚
          
          ## ðŸš€ å¿«é€Ÿå¼€å§‹
          
          ### å®‰è£…æ’ä»¶
          ```bash
          # ä¸‹è½½æœ€æ–°çš„ VSIX æ–‡ä»¶
          wget https://github.com/GoldenSupremeSaltedFish/Diffsense-artifacts/raw/main/diffsense-*.vsix
          
          # å®‰è£…åˆ° VSCode
          code --install-extension diffsense-*.vsix
          ```
          
          ### è°ƒè¯•äº§ç‰©
          ```bash
          git clone https://github.com/GoldenSupremeSaltedFish/Diffsense-artifacts.git
          cd Diffsense-artifacts
          code .
          # æŒ‰ F5 å¼€å§‹è°ƒè¯•é¢„æž„å»ºçš„äº§ç‰©
          ```
          
          ## ðŸ“ äº§ç‰©ç»“æž„
          
          ```
          â”œâ”€â”€ dist/                    # ç¼–è¯‘åŽçš„ TypeScript ä»£ç 
          â”œâ”€â”€ ui/                     # å‰ç«¯ UI æž„å»ºäº§ç‰©
          â”œâ”€â”€ analyzers/              # è¯­è¨€åˆ†æžå™¨ï¼ˆåŒ…å«ä¾èµ–ï¼‰
          â”‚   â”œâ”€â”€ *.jar              # Java åˆ†æžå™¨
          â”‚   â”œâ”€â”€ node-analyzer/     # Node.js åˆ†æžå™¨
          â”‚   â””â”€â”€ golang-analyzer/   # Golang åˆ†æžå™¨
          â”œâ”€â”€ *.vsix                  # VSCode æ’ä»¶åŒ…
          â”œâ”€â”€ runtime-config.json     # æž„å»ºå…ƒæ•°æ®
          â”œâ”€â”€ package.json           # æ’ä»¶å…ƒæ•°æ®
          â”œâ”€â”€ tsconfig.json          # TypeScript é…ç½®
          â””â”€â”€ icon.png              # æ’ä»¶å›¾æ ‡
          ```
          
          ## ðŸ”§ è¯´æ˜Ž
          
          æ­¤äº§ç‰©ä»“åº“åŒ…å«ï¼š
          - âœ… ç¼–è¯‘åŽçš„ä»£ç ï¼ˆå¯ç›´æŽ¥è¿è¡Œï¼‰
          - âœ… æ‰€æœ‰åˆ†æžå™¨çš„ JAR åŒ…å’Œ JS æ–‡ä»¶
          - âœ… å‰ç«¯æž„å»ºäº§ç‰©
          - âœ… VSCode æ’ä»¶åŒ…ï¼ˆVSIXï¼‰
          - âœ… è¿è¡Œæ—¶é…ç½®æ–‡ä»¶
          
          äº§ç‰©ç»“æž„ä¸Žæ’ä»¶æºç ä¿æŒä¸€è‡´ï¼ŒåŒ…å«æ‰€æœ‰è¿è¡Œæ—¶å¿…éœ€çš„æ–‡ä»¶ã€‚
          
          ## ðŸ“Š æž„å»ºä¿¡æ¯
          
          æŸ¥çœ‹ `runtime-config.json` èŽ·å–è¯¦ç»†çš„æž„å»ºå…ƒæ•°æ®ã€‚
          
          ## ðŸ”„ è‡ªåŠ¨æ›´æ–°
          
          æ­¤ä»“åº“ç”±ä¸»ä»“åº“çš„ CI/CD è‡ªåŠ¨æ›´æ–°ï¼Œæ¯æ¬¡ä¸»ä»“åº“æŽ¨é€éƒ½ä¼šåŒæ­¥æœ€æ–°çš„æž„å»ºäº§ç‰©ã€‚
          
          ---
          
          ðŸ”— **æºä»£ç **: [DiffSense](https://github.com/GoldenSupremeSaltedFish/DiffSense)
          EOF
          
          # æäº¤å¹¶æŽ¨é€
          git add .
          if git diff --staged --quiet; then
            echo "â„¹ï¸ æ— å˜æ›´éœ€è¦æäº¤"
          else
            echo "ðŸ“¤ æäº¤å¹¶æŽ¨é€äº§ç‰©..."
            git commit -m "ðŸ”„ åŒæ­¥äº§ç‰© v$(node -p "require('../artifacts-staging/package.json').version") - $(date +'%Y-%m-%d %H:%M:%S')"
            git push origin main
            echo "âœ… äº§ç‰©åŒæ­¥æˆåŠŸï¼"
          fi
