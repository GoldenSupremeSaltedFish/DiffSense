diffsense_check:
  stage: test
  image: python:3.12-slim
  variables:
    # å¿…é¡»é…ç½®: åœ¨ GitLab CI/CD Settings -> Variables ä¸­æ·»åŠ  DIFFSENSE_TOKEN
    # æƒé™è¦æ±‚: api (è¯»å†™ MR)
    DIFFSENSE_TOKEN: $DIFFSENSE_TOKEN 
  rules:
    # ä»…åœ¨ Merge Request è§¦å‘æ—¶è¿è¡Œ
    - if: $CI_PIPELINE_SOURCE == 'merge_request_event'
  script:
    - echo "ğŸ” Starting DiffSense Audit..."
    
    # 1. æ‹‰å– DiffSense ä»£ç  (å‡è®¾æ‚¨å°† DiffSense æ”¾åœ¨å•ç‹¬ä»“åº“æˆ–ä½œä¸ºå­æ¨¡å—)
    # æ–¹å¼ A: ç›´æ¥ Clone (æ¨è)
    - git clone https://github.com/your-org/diffsense.git /tmp/diffsense
    - pip install -r /tmp/diffsense/diffsense/requirements.txt
    
    # 2. è¿è¡Œå®¡è®¡
    # $CI_PROJECT_ID å’Œ $CI_MERGE_REQUEST_IID æ˜¯ GitLab è‡ªåŠ¨æ³¨å…¥çš„å˜é‡
    - python /tmp/diffsense/diffsense/run_audit.py \
        --platform gitlab \
        --token "$DIFFSENSE_TOKEN" \
        --project-id "$CI_PROJECT_ID" \
        --mr-iid "$CI_MERGE_REQUEST_IID" \
        --gitlab-url "$CI_SERVER_URL"

  # 3. ç­–ç•¥é…ç½®: é‡åˆ° P0 é£é™©ç›´æ¥å¤±è´¥ (Exit 1)
  allow_failure: false 
