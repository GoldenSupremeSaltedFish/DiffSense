rules:
  - id: runtime.concurrency_risk
    # Use AST Signal instead of regex match
    signal: "runtime.concurrency.synchronized"
    # match: "(?i)(thread|async|lock|synchronized)"  <-- Removed regex
    action: "added"
    file: "**/core/**"
    impact: runtime
    severity: high
    rationale: "Concurrency changes (synchronized) in core modules pose high stability risk"

  - id: runtime.concurrency_synchronized_removed_critical
    signal: "runtime.concurrency.synchronized"
    action: "removed"
    file: "**"
    impact: runtime
    severity: critical
    rationale: "CRITICAL: Removal of synchronized block/keyword detected! This is a major stability risk."

  - id: runtime.concurrency_lock_risk
    signal: "runtime.concurrency.lock"
    action: "added"
    file: "**/core/**"
    impact: runtime
    severity: high
    rationale: "Explicit lock usage in core modules"

  - id: runtime.concurrency_lock_removed_critical
    signal: "runtime.concurrency.lock"
    action: "removed"
    file: "**"
    impact: runtime
    severity: critical
    rationale: "CRITICAL: Removal of lock/concurrency protection detected! This may lead to race conditions."

  - id: runtime.concurrency_volatile_risk
    signal: "runtime.concurrency.volatile"
    action: "added"
    file: "**/core/**"
    impact: runtime
    severity: high
    rationale: "Volatile field usage in core modules"

  - id: runtime.concurrency_volatile_removed_risk
    signal: "runtime.concurrency.volatile"
    action: "removed"
    file: "**"
    impact: runtime
    severity: critical
    rationale: "CRITICAL: Removal of volatile keyword detected! This may cause visibility issues across threads."

  - id: runtime.concurrency_map_removed_risk
    signal: "runtime.concurrency.concurrent_map"
    action: "removed"
    file: "**"
    impact: runtime
    severity: high
    rationale: "Removal of ConcurrentHashMap detected. Ensure it is not replaced by a non-thread-safe collection."

  - id: runtime.concurrency.thread_safety_downgrade
    signal: "runtime.concurrency.thread_safety_downgrade"
    action: "downgrade"
    file: "**"
    impact: runtime
    severity: critical
    rationale: "CRITICAL: Detected downgrade from ThreadSafe type to Non-ThreadSafe type (e.g., ConcurrentHashMap -> HashMap). High risk of race conditions!"

  - id: runtime.concurrency.static_unsafe_collection
    signal: "runtime.concurrency.static_unsafe_collection"
    action: "added"
    file: "**"
    impact: runtime
    severity: high
    rationale: "Usage of static non-thread-safe collection detected. This is a common cause of race conditions in multi-threaded environments."

  - id: runtime.performance.sleep_added
    signal: "runtime.performance.sleep_added"
    action: "added"
    file: "**"
    impact: performance
    severity: medium
    rationale: "Thread.sleep() introduced. This may indicate poor concurrency handling or debug code left in production."

  - id: runtime.concurrency.executors_factory_risk
    signal: "runtime.concurrency.executors_factory_risk"
    action: "added"
    file: "**"
    impact: runtime
    severity: critical
    rationale: "CRITICAL: Use of Executors.newFixedThreadPool/newCachedThreadPool detected. These methods have unbounded queues or thread creation, which can lead to OOM in high-load scenarios. Use ThreadPoolExecutor manually."

  - id: runtime.concurrency.future_get_without_timeout
    signal: "runtime.concurrency.future_get_without_timeout"
    action: "added"
    file: "**"
    impact: runtime
    severity: critical
    rationale: "CRITICAL: Future.get() called without timeout. This can cause thread blocking and cascading failures (Avalanche Effect). Always use get(timeout, unit)."

  - id: runtime.concurrency.threadpool_creation
    signal: "runtime.concurrency.threadpool_creation"
    action: "added"
    file: "**"
    impact: runtime
    severity: high
    rationale: "ThreadPoolExecutor creation detected. Ensure corePoolSize, maxPoolSize, and queueCapacity are configured correctly to avoid OOM or thread explosion."

  - id: runtime.service_layer
    file: "**/service/**"
    impact: runtime
    severity: medium
    rationale: "Changes in service layer may affect business logic"

  - id: data.destructive_schema
    match: "ALTER TABLE|DROP TABLE"
    file: "**/migrations/**"
    impact: data
    severity: high
    rationale: "Destructive schema changes require careful review"

  - id: data.query_change
    match: "SELECT|INSERT|UPDATE"
    impact: data
    severity: medium
    rationale: "SQL query modifications"

  - id: architecture.dependency_change
    file: "**/package.json"
    impact: architecture
    severity: high
    rationale: "Dependency changes affect build and security"

  - id: architecture.dependency_change_python
    file: "**/requirements.txt"
    impact: architecture
    severity: high
    rationale: "Dependency changes affect build and security"

  # --- Semantic Regression Rules (Added by Request) ---

  - id: runtime.input_normalization_removed
    signal: "runtime.input_normalization_removed"
    action: "removed"
    file: "**"
    impact: runtime
    severity: high
    rationale: "CRITICAL: Removal of input normalization/validation call (encode/decode/validate/check). High risk of data integrity or security issues."

  - id: data.pagination_semantic_change
    signal: "data.pagination_semantic_change"
    action: "changed"
    file: "**"
    impact: data
    severity: high
    rationale: "Changes to pagination logic (pageNo/pageSize/start/limit) detected. High risk of off-by-one errors or data loss."

  - id: runtime.collection_mutation_inside_loop
    signal: "runtime.collection_mutation_inside_loop"
    action: "added"
    file: "**"
    impact: runtime
    severity: high
    rationale: "Collection modification (remove) detected inside a loop. This often leads to ConcurrentModificationException or undefined behavior."

  - id: security.behavior_change_auth
    file: "**/auth/**"
    impact: security
    severity: high
    rationale: "Changes in authentication modules detected. Requires careful security review."

  - id: security.behavior_change_security
    file: "**/security/**"
    impact: security
    severity: high
    rationale: "Changes in security modules detected. Requires careful security review."

  - id: runtime.validation_removed
    # This overlaps with input_normalization_removed, but we can add a specific one if needed.
    # The user asked for it as a separate category, but we covered it with the signal above.
    # Let's add a placeholder or duplicate if distinct signal is available.
    # For now, relying on input_normalization_removed covers 'validate/check' calls.
    # But let's add a rule that watches for 'validation' in filename or package.
    file: "**/validation/**"
    match: ".*" # Match any change
    impact: runtime
    severity: high
    rationale: "Changes in validation logic modules."

  # --- New Semantic Signal Rules (P0/P1/P2) ---

  - id: runtime.concurrency.lock_removed
    signal: "runtime.concurrency.lock_removed"
    action: "removed"
    file: "**"
    impact: runtime
    severity: critical
    rationale: "CRITICAL: Removal of Lock/Synchronized detected! This is a P0 stability risk (TOP1 accident cause)."

  - id: runtime.concurrency.volatile_removed
    signal: "runtime.concurrency.volatile_removed"
    action: "removed"
    file: "**"
    impact: runtime
    severity: critical
    rationale: "CRITICAL: Removal of volatile keyword detected! This causes visibility issues."

  - id: runtime.concurrency.final_removed
    signal: "runtime.concurrency.final_removed"
    action: "removed"
    file: "**"
    impact: runtime
    severity: critical
    rationale: "CRITICAL: Removal of final modifier detected! Immutable object might become mutable (thread-safety risk)."

  - id: runtime.concurrency.atomic_to_non_atomic_write
    signal: "runtime.concurrency.atomic_to_non_atomic_write"
    action: "removed"
    file: "**"
    impact: runtime
    severity: critical
    rationale: "CRITICAL: Atomic write operation removed/replaced. This is a semantic downgrade."

  - id: runtime.concurrency.threadpool_param_change
    signal: "runtime.concurrency.threadpool_param_change"
    action: "changed"
    file: "**"
    impact: runtime
    severity: high
    rationale: "ThreadPoolExecutor parameters changed. Verify corePoolSize/maxQueue/timeout logic."

  - id: runtime.concurrency.threadpool_unbounded_queue
    signal: "runtime.concurrency.threadpool_unbounded_queue"
    action: "added"
    file: "**"
    impact: runtime
    severity: critical
    rationale: "CRITICAL: Unbounded queue (LinkedBlockingQueue without capacity) detected in ThreadPool. Risk of OOM."

  - id: runtime.concurrency.busy_wait_added
    signal: "runtime.concurrency.busy_wait_added"
    action: "added"
    file: "**"
    impact: performance
    severity: critical
    rationale: "CRITICAL: Busy wait loop (while(true)) detected. High CPU usage risk."

  - id: runtime.resource.try_with_resource_removed
    signal: "runtime.resource.try_with_resource_removed"
    action: "removed"
    file: "**"
    impact: runtime
    severity: high
    rationale: "Try-with-resources block removed. Verify resource closing logic to prevent leaks."

  - id: runtime.resource.cache_eviction_removed
    signal: "runtime.resource.cache_eviction_removed"
    action: "removed"
    file: "**"
    impact: runtime
    severity: high
    rationale: "Cache eviction/TTL logic removed. Risk of memory leak/cache explosion."

  - id: runtime.network.timeout_removed
    signal: "runtime.network.timeout_removed"
    action: "removed"
    file: "**"
    impact: runtime
    severity: high
    rationale: "Timeout setting removed. Risk of thread hanging/cascading failure."

  - id: runtime.data.null_check_removed
    signal: "runtime.data.null_check_removed"
    action: "removed"
    file: "**"
    impact: runtime
    severity: medium
    rationale: "Null check removed. Potential NPE risk."

  - id: runtime.data.equals_to_reference_compare
    signal: "runtime.data.equals_to_reference_compare"
    action: "changed"
    file: "**"
    impact: runtime
    severity: high
    rationale: "Semantic change: equals() replaced by == reference comparison."
